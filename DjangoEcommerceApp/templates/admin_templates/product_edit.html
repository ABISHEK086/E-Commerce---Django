{% extends 'admin_templates/base_template.html' %}
{% block title %}
Product EDIT
{% endblock title %}

{% block custom_css %}
<link rel="stylesheet" href="//bootstrap-tagsinput.github.io/bootstrap-tagsinput/dist/bootstrap-tagsinput.css"/>
<style>
    /* Animation styles */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    
    /* Card animations */
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        animation: fadeIn 0.6s ease-out forwards;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }
    
    /* Form enhancements */
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 15px;
        transition: all 0.3s;
        box-shadow: none;
    }
    
    .form-control:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        transform: translateY(-2px);
    }
    
    /* Button enhancements */
    .btn {
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
        padding: 10px 20px;
        font-size: 14px;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #4361ee, #3a0ca3);
        border: none;
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 20px rgba(67, 97, 238, 0.4);
        color: white;
    }
    
    .btn-success {
        background: linear-gradient(45deg, #4caf50, #2e7d32);
        border: none;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        color: white;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 20px rgba(76, 175, 80, 0.4);
        color: white;
    }
    
    .btn-danger {
        background: linear-gradient(45deg, #f44336, #c62828);
        border: none;
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        color: white;
    }
    
    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 20px rgba(244, 67, 54, 0.4);
        color: white;
    }
    
    .btn-warning {
        background: linear-gradient(45deg, #ff9800, #f57c00);
        border: none;
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        color: white;
    }
    
    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 20px rgba(255, 152, 0, 0.4);
        color: white;
    }
    
    /* Section headers */
    h5 {
        color: #4361ee;
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        animation: fadeIn 0.6s ease-out;
    }
    
    hr {
        border-top: 2px solid #4361ee;
        opacity: 0.2;
        margin-bottom: 30px;
    }
    
    /* Bootstrap tagsinput customization */
    .bootstrap-tagsinput {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 10px 15px;
        transition: all 0.3s;
        box-shadow: none;
    }
    
    .bootstrap-tagsinput:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }
    
    /* Progress bar styling */
    .progress {
        height: 30px;
        border-radius: 10px;
        background-color: #e9ecef;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .progress-bar {
        background: linear-gradient(45deg, #4361ee, #3a0ca3);
        transition: width 0.5s ease;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Image preview styling */
    .image-preview-container {
        margin-top: 20px;
        text-align: center;
        animation: fadeIn 0.6s ease-out;
    }
    
    .image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .image-preview:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .upload-btn-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        margin-top: 15px;
    }
    
   .upload-btn {
    background-color: #ffffff !important;
    color: #001f54 !important;
    border: 2px solid #001f54 !important;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s;
}
.upload-btn:hover {
    background-color: #001f54 !important;
    color: #ffffff !important;
    transform: translateY(-2px);
}

    
    .upload-btn-wrapper input[type=file] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
    }
    
    /* Animation for form sections */
    .form-section {
        animation: slideInRight 0.5s ease-out;
        margin-bottom: 30px;
    }
    
    /* Success message */
    .alert-success {
        background: linear-gradient(45deg, #4caf50, #2e7d32);
        color: white;
        border: none;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
        animation: fadeIn 0.6s ease-out;
    }
    
    /* Add/Remove buttons animation */
    .add-remove-buttons {
        animation: pulse 2s infinite;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .btn {
            margin-bottom: 10px;
        }
    }
</style>
{% endblock custom_css %}

{% block page_title %}
Product EDIT
{% endblock page_title %}

{% block page_content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <form id="myform" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="card-body">
                    <!-- Product Picture Upload Section -->
                    <div class="form-section">
                        <h5>Product Picture</h5>
                        <hr>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="upload-btn-wrapper">
                                    <button class="btn btn-primary upload-btn">
                                        <i class="fas fa-upload"></i> Upload Product Picture
                                    </button>
                                    <input type="file" name="product_picture" accept="image/*" id="product_picture" />
                                </div>
                            </div>
                        </div>
                        <div class="image-preview-container" id="image_preview_container">
                            {% if product.product_picture %}
                                <img src="{{ product.product_picture.url }}" class="image-preview" id="image_preview" alt="Product Preview">
                            {% else %}
                                <img src="" class="image-preview" id="image_preview" alt="Product Preview" style="display: none;">
                            {% endif %}
                        </div>
                    </div>

                    <!-- Product Basic Details Section -->
                    <div class="form-section">
                        <h5>Product Basic Details #{{ product.id }}</h5>
                        <hr>
                        <div class="row"> 
                            <div class="col-lg-6">
                                <label>Product Name</label>
                                <input class="form-control" name="product_name" placeholder="Product Name" id="title" value="{{ product.product_name }}" />
                            </div>
                            <div class="col-lg-6">
                                <label>Brand</label>
                                <input class="form-control" name="brand" placeholder="Brand" value="{{ product.brand }}"/>
                            </div>
                        </div>
                        <br>
                        <div class="row"> 
                            <div class="col-lg-6">
                                <label>Url Slug</label>
                                <input class="form-control" name="url_slug" placeholder="Url Slug" id="url_slug" value="{{ product.url_slug }}"/>
                            </div>
                            <div class="col-lg-6">
                                <label>Category</label>
                                <select name="sub_category" class="form-control">
                                    {% for category in categories %}
                                        <optgroup label="{{ category.category.title }}">
                                        {% for sub_cat in category.sub_category %}
                                            <option value="{{ sub_cat.id }}" {% if sub_cat.id == product.subcategories_id.id %} selected {% endif %}>{{ sub_cat.title }}</option>
                                        {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <br>
                        <div class="row"> 
                            <div class="col-lg-6">
                                <label>Max Price</label>
                                <input class="form-control" name="product_max_price" placeholder="Max Price" value="{{ product.product_max_price }}" />
                            </div>
                            <div class="col-lg-6">
                                <label>Discount Price</label>
                                <input class="form-control" name="product_discount_price" placeholder="Discount Price" value="{{ product.product_discount_price }}"/>
                            </div>
                        </div>
                        <br>
                        <div class="row"> 
                            <div class="col-lg-12">
                                <label>Product Short Description</label>
                                <textarea class="form-control" name="product_description" rows="6">{{ product.product_description }}</textarea>
                            </div>
                        </div>
                        <br>
                        <div class="row"> 
                            <div class="col-lg-12">
                                <label>Product Long Description</label>
                                <textarea class="form-control" name="product_long_description" id="long_desc"></textarea>
                            </div>
                        </div>
                    </div>
                   
                    <!-- Product Details Section -->
                    <div class="form-section">
                        <h5>Product Details</h5>
                        <hr>
                        <div class="">
                        {% for details in product_details %}
                            <div class="row">
                                <div class="col-lg-6">
                                    <label>Title</label>
                                    <input type="text" name="title_title[]" value="{{ details.title }}" class="form-control title_title" placeholder="Title">
                                    <input type="hidden" name="details_id[]" value="{{ details.id }}">
                                </div>
                                <div class="col-lg-6">
                                    <label>Details</label>
                                    <input type="text" name="title_details[]" value="{{ details.title_details }}" class="form-control title_details" placeholder="Title Details"/>
                                </div>
                            </div>
                        {% endfor %}
                        </div>

                        <div class="details_div">
                        <div class="row details_div_row first_details">
                            <div class="col-lg-6">
                                <label>Title</label>
                                <input type="text" name="title_title[]" class="form-control title_title" placeholder="Title">
                                <input type="hidden" name="details_id[]" value="blank">
                            </div>
                            <div class="col-lg-6">
                                <label>Details</label>
                                <input type="text" name="title_details[]" class="form-control title_details" placeholder="Title Details"/>
                            </div>
                        </div>
                        </div>
                        <br>
                        <div class="row add-remove-buttons">
                            <div class="col-lg-6">
                                <button class="btn btn-success btn-block add_details" type="button">
                                    <i class="fas fa-plus"></i> ADD DETAILS
                                </button>
                            </div>
                            <div class="col-lg-6">
                                <button class="btn btn-danger btn-block remove_details" type="button">
                                    <i class="fas fa-minus"></i> REMOVE DETAILS
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product About Section -->
                    <div class="form-section">
                        <h5>Product About</h5>
                        <hr>
                        <div class="">
                        {% for about in product_about %}
                        <div class="row">
                            <div class="col-lg-12">
                                <label>Title</label>
                                <input type="text" name="about_title[]" value="{{ about.title }}" class="form-control about_title" placeholder="Title">
                                <input type="hidden" name="about_id[]" value="{{ about.id }}" >
                            </div>
                        </div>
                        {% endfor %}
                        </div>
                        <div class="about_div">
                        <div class="row about_div_row first_about">
                            <div class="col-lg-12">
                                <label>Title</label>
                                <input type="hidden" name="about_id[]" value="blank">
                                <input type="text" name="about_title[]" class="form-control about_title" placeholder="Title">
                            </div>
                        </div>
                        </div>
                        <br>
                        <div class="row add-remove-buttons">
                            <div class="col-lg-6">
                                <button class="btn btn-success btn-block add_about" type="button">
                                    <i class="fas fa-plus"></i> ADD ABOUT DETAILS
                                </button>
                            </div>
                            <div class="col-lg-6">
                                <button class="btn btn-danger btn-block remove_about" type="button">
                                    <i class="fas fa-minus"></i> REMOVE ABOUT DETAILS
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Tags Section -->
                    <div class="form-section">
                        <h5>Product Tags</h5>
                        <hr>
                        <div class="row">
                            <div class="col-lg-12">
                                    <input type="text" name="product_tags" value="{% for tag in product_tags  %} {{tag.title}} , {% endfor %}"  data-role="tagsinput"  />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="form-section">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class='progress mb-3'>
                                    <div class="progress-bar bg-warning" id="progressbar" role="progressbar" data-width="0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="display:none;width: 0%;">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="form-section">
                        <div class="row">
                            <button type="button" class="btn btn-primary btn-block submit_btn">
                                <i class="fas fa-save"></i> UPDATE PRODUCT
                            </button>
                        </div>
                    </div>
                 </div>
            </form>
        </div>
    </div>
</div>
{% endblock page_content %}

{% block custom_js %}
<script src="//cdn.tiny.cloud/1/u6oa5pnpaa1vxho1md7uk4zmq2ai7xuf5o5wfgyrc131vpj6/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
<script>
  tinymce.init({
        selector: "textarea#long_desc",
        height: 300,
        plugins: [
            "advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker",
            "searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime nonbreaking",
            "save table contextmenu directionality emoticons template paste textcolor",
        ],
        images_upload_url:"{% url 'file_upload' %}",
        toolbar: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | l      ink image | print preview media fullpage | forecolor backcolor emoticons",
        style_formats: [
            { title: "Bold text", inline: "b" },
            { title: "Red text", inline: "span", styles: { color: "#ff0000" } },
            { title: "Red header", block: "h1", styles: { color: "#ff0000" } },
            { title: "Example 1", inline: "span", classes: "example1" },
            { title: "Example 2", inline: "span", classes: "example2" },
            { title: "Table styles" },
            { title: "Table row 1", selector: "tr", classes: "tablerow1" },
        ],
        automatic_uploads: true,
        file_picker_types: 'image',
        file_picker_callback: function (cb, value, meta) {
        var input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');

        input.onchange = function () {
        var file = this.files[0];

        var reader = new FileReader();
        reader.onload = function () {
            var id = 'blobid' + (new Date()).getTime();
            var blobCache =  tinymce.activeEditor.editorUpload.blobCache;
            var base64 = reader.result.split(',')[1];
            var blobInfo = blobCache.create(id, file, base64);
            blobCache.add(blobInfo);

            cb(blobInfo.blobUri(), { title: file.name });
        };
        reader.readAsDataURL(file);
        };

        input.click();
    },
});

$(document).ready(function(){
    // Set TinyMCE content
    tinyMCE.get("long_desc").on("init",function(e){
        e.target.setContent("{{ product.product_long_description|safe }}")
    });
    
    // Image preview functionality
    $("#product_picture").change(function(){
        readURL(this);
    });
    
    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            
            reader.onload = function(e) {
                $('#image_preview').attr('src', e.target.result);
                $('#image_preview').show();
                $('#image_preview').css('animation', 'fadeIn 0.6s ease-out');
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }
});

// Add/Remove functionality
$(".add_details").click(function(){
    var details_row=$(".first_details").clone();
    details_row.removeClass("first_details");
    details_row.find(".title_title").val("");
    details_row.find(".title_details").val("");
    details_row.hide().appendTo(".details_div").fadeIn(500);
});

$(".remove_details").click(function(){
    if($(".details_div").find(".details_div_row").length>1){
        $(".details_div").children().last().fadeOut(300, function() {
            $(this).remove();
        });
    }
});

$(".add_about").click(function(){
    var about_row=$(".first_about").clone();
    about_row.removeClass("first_about");
    about_row.find(".about_title").val("");
    about_row.hide().appendTo(".about_div").fadeIn(500);
});

$(".remove_about").click(function(){
    if($(".about_div").find(".about_div_row").length>1){
        $(".about_div").children().last().fadeOut(300, function() {
            $(this).remove();
        });
    }
});

// Form submission
$(".submit_btn").click(function(){
    var form=new FormData($("#myform")[0]);
    form.append("long_desc",tinyMCE.activeEditor.getContent());

    //AJAX CODE
    var xhr=new XMLHttpRequest();
    xhr.onreadystatechange=function(){
        if(xhr.readyState === 4 && xhr.status === 200) {
            try {
                var response = JSON.parse(xhr.responseText);
                if(response.status === 'success') {
    $(".card-body").prepend(
        '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
        '<strong>Success!</strong> ' + response.message +
        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
        '</div>'
    );

    // âœ… Update preview dynamically if backend sends image_url
    if(response.image_url){
        $("#image_preview").attr("src", response.image_url).show();
    }

    $('html, body').animate({ scrollTop: 0 }, 500);
}
            } catch(e) {
                console.log("Error parsing response", e);
            }
        }
    };
    
    xhr.open("POST","{% url 'product_edit' product_id=product.id %}",true);
    $("#progressbar").show();

    //UPDATING PROGRESS BAR
    xhr.upload.addEventListener("progress",function(ev){
        if(ev.lengthComputable){
            var percentage=(ev.loaded/ev.total*100|0);
            $("#progressbar").css({"width":""+percentage+"%"}).text("Uploading .."+percentage+"%");
            
            if(percentage >= 100) {
                // Add a slight delay before reloading to show 100%
                setTimeout(function() {
                    location.reload();
                }, 500);
            }
        }
    });

    xhr.send(form);
});

</script>
<script src="//bootstrap-tagsinput.github.io/bootstrap-tagsinput/dist/bootstrap-tagsinput.min.js"></script>
{% endblock custom_js %}